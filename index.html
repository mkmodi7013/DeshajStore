<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Deshaj Store - Organic Products</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="orange">
<link rel="icon" href="icon-192.png">

<style>
* { box-sizing:border-box; margin:0; padding:0; }
body { font-family: Arial, sans-serif; background:#f7f7f7; color:#333; transition: 0.3s; }

/* ‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§Æ‡•á‡§Ç ‡§¨‡•â‡§ü‡§Æ ‡§®‡•á‡§µ‡§ø‡§ó‡•á‡§∂‡§® ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ú‡§ó‡§π */
@media (max-width: 768px) {
  body { padding-bottom: 80px; }
}

/* Cards Grid */
.product-row { display:grid; grid-template-columns:repeat(auto-fill,minmax(160px,1fr)); gap:15px; padding:15px; }
.card { background:#fff; padding:12px; border-radius:10px; text-align:center; box-shadow:0 0 10px #ccc; cursor:pointer; transition:.3s; }
.card:hover { box-shadow:0 0 15px #bbb; transform: translateY(-3px); }
.card img { width:100%; height:150px; object-fit:cover; border-radius:10px; background: #eee; }
.card h4 { margin-top:10px; font-size:16px; color:#333; height: 40px; overflow: hidden; }
.card .price { font-size:17px; font-weight:bold; color:green; margin:5px 0; }
.card .avg-rating { color:#ff9800; font-size:14px; cursor:pointer; text-decoration:underline; margin-bottom:6px; display:block; }
.card button { background:orange; color:white; padding:10px; border-radius:6px; border:none; cursor:pointer; width:100%; margin-top:10px; font-weight: bold; }
.card button:disabled { background:gray; cursor:not-allowed; }

/* Banner */
.banner { width:100%; height:180px; background: #ddd url('banner.webp') center/cover no-repeat; margin-bottom:10px; }

/* View All Button */
.view-btn { display:block; margin:10px auto 30px auto; background:orange; color:white; padding:12px 20px; border-radius:6px; text-align:center; text-decoration:none; width:160px; font-weight: bold; }

/* Suggestion Box */
.suggest-box { background:#fff; padding:15px; margin:15px; border-radius:10px; box-shadow:0 0 10px #ccc; }
.suggest-box textarea { width:100%; height:80px; padding:10px; border-radius:8px; border:1px solid #ccc; font-size:14px; resize:none; margin-top: 10px; }
.suggest-box button { margin-top:10px; width:100%; background:orange; color:white; padding:10px; border-radius:8px; border:none; cursor:pointer; font-size:16px; }

/* Popup for Reviews */
#reviewPopup { position:fixed; inset:0; background:rgba(0,0,0,0.7); display:none; align-items:center; justify-content:center; padding:20px; z-index:10001; }
#reviewPopup .panel { background:#fff; width:100%; max-width:400px; border-radius:12px; padding:20px; max-height:80%; overflow-y:auto; }
#closePopup { margin-top:15px; width:100%; padding:10px; background:orange; color:#fff; border:none; border-radius:6px; cursor:pointer; font-weight: bold; }
.single-review { border-bottom: 1px solid #eee; padding:10px 0; }

/* Custom Cart Toast */
#cartToast { display:none; position:fixed; bottom:85px; left:50%; transform:translateX(-50%); background:#333; color:white; padding:15px 20px; border-radius:12px; z-index:10000; box-shadow:0 5px 20px rgba(0,0,0,0.4); text-align:center; min-width:280px; }
</style>
</head>
<body>

<div id="header"></div>

<div class="banner"></div>

<h2 style="padding-left:15px; margin-top:10px;">Latest Organic Products</h2>

<div class="suggest-box">
  <h3>üí¨ Have a Suggestion?</h3>
  <textarea id="suggestionInput" placeholder="Write your suggestion..." maxlength="250"></textarea>
  <button id="submitSuggestionBtn">Submit Suggestion</button>
</div>

<div class="product-row" id="latestProducts">Loading products...</div>
<a class="view-btn" href="shop.html">View All Products</a>

<!-- Reviews Popup -->
<div id="reviewPopup">
  <div class="panel">
    <h3 id="popProductName">Reviews</h3>
    <div id="popupReviews">Loading...</div>
    <button id="closePopup">Close</button>
  </div>
</div>

<!-- Custom Cart Notification -->
<div id="cartToast">
  <p id="cartToastMsg" style="margin-bottom:10px;"></p>
  <div style="display:flex; gap:10px; justify-content:center;">
    <button onclick="document.getElementById('cartToast').style.display='none'" style="background:#555; color:white; border:none; padding:8px 15px; border-radius:5px; cursor:pointer;">Continue</button>
    <a href="cart.html" style="background:orange; color:white; text-decoration:none; padding:8px 15px; border-radius:5px; font-weight:bold;">Go to Cart</a>
  </div>
</div>

<script type="module">
import { initializeApp } from "www.gstatic.com";
import { 
  getFirestore, collection, getDocs, query, orderBy,
  addDoc, serverTimestamp, where 
} from "www.gstatic.com";

// Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyA6izuR2_oyHbAVhkIVkH0OHj6yAOduD_8",
  authDomain: "apna-kitchen-acdcc.firebaseapp.com",
  projectId: "apna-kitchen-acdcc",
  storageBucket: "apna-kitchen-acdcc.appspot.com",
  messagingSenderId: "129562055761",
  appId: "1:129562055761:web:baa01f9fea6f8eed025470"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// 1. Header Load
fetch('header.html').then(r=>r.text()).then(t=>document.getElementById('header').innerHTML=t);

// 2. Suggestion Logic
document.getElementById("submitSuggestionBtn").onclick = async () => {
  const text = document.getElementById("suggestionInput").value.trim();
  if(!text) return alert("Please enter text");
  try {
    await addDoc(collection(db, "suggestions"), { suggestion: text, createdAt: serverTimestamp() });
    alert("Suggestion sent!");
    document.getElementById("suggestionInput").value = "";
  } catch(e) { alert("Error sending"); }
};

// 3. Optimized Load Products (Parallel Execution)
async function loadProducts() {
  const container = document.getElementById("latestProducts");
  try {
    const q = query(collection(db, "products"), orderBy("createdAt", "desc"));
    const snap = await getDocs(q);
    container.innerHTML = "";

    // ‡§∏‡§≠‡•Ä ‡§™‡•ç‡§∞‡•â‡§Æ‡§ø‡§∏ ‡§è‡§ï ‡§∏‡§æ‡§• ‡§ö‡§≤‡§æ‡§è‡§Ç (SPEED BOOST)
    const productDataPromises = snap.docs.map(async (doc) => {
      const p = doc.data();
      const id = doc.id;
      const [rating, qty] = await Promise.all([
        getAverageRating(id),
        getStockQty(id)
      ]);
      return { id, p, rating, qty };
    });

    const products = await Promise.all(productDataPromises);

    products.forEach(({ id, p, rating, qty }) => {
      const isOutOfStock = qty <= 0;
      const card = document.createElement("div");
      card.className = "card";
      card.onclick = () => window.location.href = `product-details.html?id=${id}`;
      
      card.innerHTML = `
        <img src="${p.image}" alt="${p.name}" loading="lazy">
        <h4>${p.name}</h4>
        <p class="price">‚Çπ${p.price}</p>
        <div class="avg-rating" onclick="event.stopPropagation(); showReviews('${id}','${p.name}')">
          ${getStarsHTML(rating.avg)} (${rating.total})
        </div>
        <button 
          ${isOutOfStock ? "disabled" : ""} 
          onclick="event.stopPropagation(); addToCart(event,'${id}','${p.name}','${p.price}','${p.image}')"
        >
          ${isOutOfStock ? "Out of Stock" : "Add to Cart"}
        </button>
      `;
      container.appendChild(card);
    });
  } catch(e) { container.innerHTML = "Failed to load products."; }
}

// 4. Stock Checker
async function getStockQty(pid) {
  try {
    const q = query(collection(db, "stock"), where("productId", "==", pid));
    const snap = await getDocs(q);
    if(snap.empty) return 0;
    return Number(snap.docs[0].data().quantity) || 0;
  } catch(e) { return 0; }
}

// 5. Rating System
async function getAverageRating(pid) {
  try {
    const snap = await getDocs(collection(db, "reviews", pid, "items"));
    if(snap.empty) return { avg: 0, total: 0 };
    let sum = 0;
    snap.forEach(d => sum += Number(d.data().rating) || 0);
    return { avg: (sum / snap.size).toFixed(1), total: snap.size };
  } catch(e) { return { avg: 0, total: 0 }; }
}

function getStarsHTML(avg) {
  return "‚òÖ".repeat(Math.floor(avg)) + "‚òÜ".repeat(5 - Math.floor(avg));
}

// 6. Show Reviews
window.showReviews = async (pid, name) => {
  document.getElementById("popProductName").textContent = name;
  const pop = document.getElementById("reviewPopup");
  const box = document.getElementById("popupReviews");
  pop.style.display = "flex";
  box.innerHTML = "Loading reviews...";

  const snap = await getDocs(collection(db, "reviews", pid, "items"));
  box.innerHTML = snap.empty ? "No reviews yet." : "";
  snap.forEach(d => {
    const r = d.data();
    box.innerHTML += `<div class="single-review"><strong>${r.rating} ‚òÖ</strong><p>${r.comment || ''}</p></div>`;
  });
};

document.getElementById("closePopup").onclick = () => document.getElementById("reviewPopup").style.display="none";

// 7. Add to Cart with Custom Toast
window.addToCart = (e, id, name, price, image) => {
  e.stopPropagation();
  let cart = JSON.parse(localStorage.getItem("cart")) || [];
  let exist = cart.find(i => i.id === id);
  if(exist) exist.qty += 1;
  else cart.push({ id, name, price: Number(price), image, qty: 1 });
  
  localStorage.setItem("cart", JSON.stringify(cart));
  
  const toast = document.getElementById("cartToast");
  document.getElementById("cartToastMsg").innerText = `‚úÖ ${name} added!`;
  toast.style.display = "block";
  setTimeout(() => toast.style.display = "none", 4000);
};

// Start
loadProducts();
</script>
</body>
</html>
