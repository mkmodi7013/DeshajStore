<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Edit Product - Deshaj Store</title>

<style>
  body {
    font-family: Arial;
    background: #f7f7f7;
    padding: 20px;
  }
  h2 {
    text-align: center;
    color: orange;
  }

  .form-box {
    background: #fff;
    padding: 20px;
    border-radius: 10px;
    max-width: 450px;
    margin: auto;
    box-shadow: 0 0 10px #ccc;
  }

  input, select, textarea {
    width: 100%;
    padding: 10px;
    margin: 10px 0;
    border: 1px solid #ccc;
    border-radius: 6px;
  }

  button {
    width: 100%;
    padding: 12px;
    background: orange;
    color: white;
    border: none;
    border-radius: 6px;
    font-size: 18px;
    cursor: pointer;
  }

  #prevImage, #newPreview {
    width: 100%;
    height: 250px;
    object-fit: cover;
    border-radius: 8px;
    margin-bottom: 10px;
  }

  button:hover {
    background: #e67e00;
  }

  #status {
    text-align: center;
    margin-top: 10px;
  }
</style>

</head>
<body>

<h2>Edit Product</h2>

<div class="form-box">

  <h3>Current Image</h3>
  <img id="prevImage">

  <input type="text" id="name" placeholder="Product Name">
  <input type="number" id="price" placeholder="Price (₹)">
  <textarea id="desc" placeholder="Product Description"></textarea>

  <select id="category">
    <option value="Oil">Oil</option>
    <option value="Grocery">Grocery</option>
    <option value="Organic">Organic</option>
  </select>

  <label><b>Upload New Image (optional)</b></label>
  <input type="file" id="newImage" accept="image/*">

  <img id="newPreview" style="display:none;">

  <button onclick="updateProduct()">Update Product</button>

  <p id="status"></p>
</div>

<script type="module">

  const firebaseConfig = {
    apiKey: "AIzaSyA6izuR2_oyHbAVhkIVkH0OHj6yAOduD_8",
    authDomain: "apna-kitchen-acdcc.firebaseapp.com",
    projectId: "apna-kitchen-acdcc",
    storageBucket: "apna-kitchen-acdcc.appspot.com",
    messagingSenderId: "129562055761",
    appId: "1:129562055761:web:baa01f9fea6f8eed025470"
  };

  import { initializeApp } 
    from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";

  import { 
    getFirestore, doc, getDoc, updateDoc 
  } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

  import {
    getStorage, ref, uploadBytes, getDownloadURL
  } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-storage.js";

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const storage = getStorage(app);

  // GET PRODUCT ID FROM URL
  const urlParams = new URLSearchParams(window.location.search);
  const productId = urlParams.get("id");

  async function loadProduct() {
    if (!productId) {
      status.innerText = "Invalid Product ID";
      return;
    }

    const docRef = doc(db, "products", productId);
    const snap = await getDoc(docRef);

    if (!snap.exists()) {
      status.innerText = "Product not found!";
      return;
    }

    const p = snap.data();

    document.getElementById("name").value = p.name;
    document.getElementById("price").value = p.price;
    document.getElementById("desc").value = p.description;
    document.getElementById("category").value = p.category;
    document.getElementById("prevImage").src = p.image;
  }

  loadProduct();



  // ⭐ IMAGE VALIDATION (max 300KB, resolution 800–1200px)
  const newImageInput = document.getElementById("newImage");
  let validatedFile = null;

  newImageInput.addEventListener("change", function (e) {
    const file = e.target.files[0];
    if (!file) return;

    // Size Check
    if (file.size > 300 * 1024) {
      alert("❌ Maximum allowed image size is 300KB.");
      newImageInput.value = "";
      return;
    }

    const img = new Image();
    img.src = URL.createObjectURL(file);

    img.onload = function () {
      if (
        img.width < 800 || img.height < 800 ||
        img.width > 1200 || img.height > 1200
      ) {
        alert("❌ Image resolution must be between 800px – 1200px.");
        newImageInput.value = "";
        return;
      }

      validatedFile = file;
      document.getElementById("newPreview").style.display = "block";
      document.getElementById("newPreview").src = img.src;
    };
  });




  // -------------------------------
  // UPDATE PRODUCT
  // -------------------------------
  async function updateProduct() {

    const name = document.getElementById("name").value;
    const price = document.getElementById("price").value;
    const desc = document.getElementById("desc").value;
    const category = document.getElementById("category").value;

    const status = document.getElementById("status");
    status.innerText = "Updating...";
    status.style.color = "black";

    let newImageURL = null;

    try {

      // Upload new image if selected
      if (validatedFile) {
        const imgRef = ref(storage, "products/" + productId + ".jpg");
        await uploadBytes(imgRef, validatedFile);
        newImageURL = await getDownloadURL(imgRef);
      }

      // Update Firestore
      await updateDoc(doc(db, "products", productId), {
        name,
        price,
        description: desc,
        category,
        ...(newImageURL && { image: newImageURL })
      });

      status.style.color = "green";
      status.innerText = "✔ Product Updated Successfully!";
      alert("Product Updated!");

    } catch (err) {
      status.style.color = "red";
      status.innerText = "Error: " + err.message;
    }
  }

  window.updateProduct = updateProduct;

</script>

</body>
</html>
